<!DOCTYPE html>
<html lang="en">
<head>
  <title>ClearStats</title>

  <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="bower_components/underscore/underscore.js"></script>    
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="js/opencpu-0.5.js"></script>
  <script src="bower_components/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

  <script>
    $(function(){
      var editorA = ace.edit("editorA");
      editorA.setTheme("ace/theme/textmate");
      editorA.getSession().setMode("ace/mode/r");
      editorA.setFontSize("14px");
      editorA.setValue("10, 16, 20, 20, 24, 30", 1); // 1 => cursor pos at end

      var editorB = ace.edit("editorB");
      editorB.setTheme("ace/theme/solarized_light");
      editorB.getSession().setMode("ace/mode/r");
      editorB.setFontSize("14px");
      editorB.setValue("22, 22, 24, 28, 40, 55", 1); // 1 => cursor pos at end

      //This app requires OpenCPU 1.0.1 or higher!

      function parse_dataset_from_string(str){
        // Split then parse to float. Might return NaN for non-number strings.
        var values = str.split(/\s*(?:,|;|\s+)\s*/).map(parseFloat);

        // Filter so NaN is not returned.
        var result = _.filter(values, function(n){ return !isNaN(n)});
        
        return( result );
      }

      function draw_densityplot(args){
        var req = $("#densityplot").rplot("density_plot", args).fail(function(){
          alert(req.responseText);
        });
      }

      function parse_datasets() {
        var result = {
          "a" : parse_dataset_from_string(editorA.getValue()),
          "b" : parse_dataset_from_string(editorB.getValue())          
        }
        return(result);
      }

      var datasets;

      // Comparing objects for equality in Javascript is quite complex but this
      // should take care of it even if recursive hash-like objects etc.
      function isEqualRecursiveCompare(obj, reference){
        if(obj === reference) return true;
        if(obj.constructor !== reference.constructor) return false;
        if(obj instanceof Array){
          if(obj.length !== reference.length) return false;
          for(var i=0, len=obj.length; i<len; i++){
            if(typeof obj[i] == "object" && typeof reference[j] == "object"){
              if(!isEqualRecursiveCompare(obj[i], reference[i])) return false;
            } else if(obj[i] !== reference[i]) {return false;}
          }
        } else {
          var objListCounter = 0;
          var refListCounter = 0;
          for(var i in obj){
            objListCounter++;
            if(typeof obj[i] == "object" && typeof reference[i] == "object"){
              if(!isEqualRecursiveCompare(obj[i], reference[i])) return false;
            }
            else if(obj[i] !== reference[i]) return false;
          }
          for(var i in reference) refListCounter++;
            if(objListCounter !== refListCounter) return false;
        }
        return true; //Every object and array is equal
      }

      function update_if_input_changed(){
        var dsets = parse_datasets();

        // We only update if there was actually a change in the datasets entered
        // in the editor windows...
        if(isEqualRecursiveCompare(dsets, datasets)) {
          // console.log("No change!")
        } else {
          datasets = dsets;
          // console.log("Changed!")
          draw_densityplot(datasets);
        }
      }

      //auto run after 3 seconds of no activity
      //var update = _.debounce(domarkdown, 3000);

      //register events
      editorA.on("change", update_if_input_changed);
      editorB.on("change", update_if_input_changed);

      //draw on start
      datasets = parse_datasets();
      draw_densityplot(datasets);

      // Set editor A in focus
      editorA.focus();
    });
</script>

<style type="text/css" media="screen">
  body { 
    padding-top: 65px; 
  }

  #editorA { 
    border: 1px solid #DFDFDF;
    -moz-border-radius: 3px; 
    -webkit-border-radius: 3px; 
    border-radius: 3px;
    height: 60px;
    width: 100%;
  }

  #editorB { 
    border: 1px solid #DFDFDF;
    -moz-border-radius: 3px; 
    -webkit-border-radius: 3px; 
    border-radius: 3px;
    height: 60px;
    width: 100%;
  }

  #densityplot {
    height: 320px;
  }
</style>

</head>
<body>

  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">ClearStats</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#">Compare 2</a></li>
          <li><a href="#">Analyze 1</a></li>
          <li><a href="#">Help</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-1"></div>

    <div class="col-md-5">
      <div id="densityplot"></div>
    </div>

    <div class="col-md-4">
    </div>

    <div class="col-md-1"></div>


  </div>

  <div class="row">
    <div class="col-md-1"></div>
    <hr>
    <div class="col-md-1"></div>
  </div>

  <div class="row">

    <div class="col-md-1"></div>

    <div class="col-md-5">

      <div class="panel panel-default">
        <div class="panel-heading"><strong>Data set A</strong></div>
        <div class="panel-body">
          <div id="editorA"></div>

          <br />

          <table id="normalityTableA" class="table table-striped table-bordered table-condensed table-hovered">
            <thead>
              <tr>
                <th>Test</th>
                <th>p-value</th>
                <th>Normal?</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Andersson-Darling</th>
                <th>0.04</th>
                <th>Yes!</th>
              </tr>

              <tr>
                <th>Mises-Cramer</th>
                <th>0.10</th>
                <th>No!</th>
              </tr>
            </tbody>
          </table>

        </div>

        <div id="textA">
        </div>

      </div>


    </div>

    <div class="col-md-5">

      <div class="panel panel-default">
        <div class="panel-heading"><strong>Data set B</strong></div>
        <div class="panel-body">
          <div id="editorB"></div>
        </div>
      </div>

    </div>

    <div class="col-md-1"></div>

  </div>

</body>
</html>
